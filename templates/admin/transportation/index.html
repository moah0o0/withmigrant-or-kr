{% extends 'admin/base.html' %}

{% block title %}대중교통 관리{% endblock %}

{% block breadcrumb %}
<span class="text-notion-text-secondary">사이트 설정</span>
<span class="mx-2 text-notion-text-muted">/</span>
<span class="text-notion-text font-medium">대중교통</span>
{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-xl font-semibold text-notion-text">대중교통 관리</h1>
        <p class="text-sm text-notion-text-muted mt-1">소개 페이지에 표시되는 주변 정류장과 버스 노선을 관리합니다.</p>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- 주변 정류장 -->
    <div class="card-notion">
        <div class="p-4 border-b border-notion-border">
            <h2 class="font-semibold text-notion-text">주변 정류장</h2>
        </div>
        <div class="p-4">
            <!-- 추가 폼 -->
            <form method="POST" action="{{ url_for('admin.transportation_add_stop') }}" class="flex gap-2 mb-4">
                <input type="text" name="name" placeholder="정류장 이름" required
                       class="input-notion flex-1">
                <button type="submit" class="btn-notion btn-primary">추가</button>
            </form>

            <!-- 정류장 목록 -->
            <ul id="bus-stops-list" class="space-y-2">
                {% for stop in bus_stops %}
                <li class="flex items-center gap-2 p-2 bg-notion-sidebar rounded group" data-id="{{ stop.id }}">
                    <span class="cursor-move text-notion-text-muted drag-handle">⋮⋮</span>
                    <span class="text-dark-400 text-sm">{{ loop.index }}.</span>
                    <span class="flex-1 text-sm text-notion-text">{{ stop.name }}</span>
                    <button onclick="deleteStop({{ stop.id }})"
                            class="text-xs text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">삭제</button>
                </li>
                {% else %}
                <li class="text-sm text-notion-text-muted text-center py-4">등록된 정류장이 없습니다.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- 버스 노선 -->
    <div class="card-notion">
        <div class="p-4 border-b border-notion-border">
            <h2 class="font-semibold text-notion-text">버스 노선</h2>
        </div>
        <div class="p-4">
            <!-- 추가 폼 -->
            <form method="POST" action="{{ url_for('admin.transportation_add_route') }}" class="flex gap-2 mb-4">
                <select name="route_type" class="input-notion w-24">
                    <option value="일반">일반</option>
                    <option value="좌석">좌석</option>
                    <option value="마을">마을</option>
                </select>
                <input type="text" name="name" placeholder="버스 번호 (예: 26, 10(출근))" required
                       class="input-notion flex-1">
                <button type="submit" class="btn-notion btn-primary">추가</button>
            </form>

            <!-- 일반 버스 -->
            <div class="mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <span class="px-2 py-0.5 bg-green-600 text-white text-xs font-medium rounded">일반</span>
                </div>
                <div class="flex flex-wrap gap-1">
                    {% for route in routes_by_type['일반'] %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-notion-sidebar text-sm rounded group">
                        {{ route.name }}
                        <button onclick="deleteRoute({{ route.id }})"
                                class="text-red-500 opacity-0 group-hover:opacity-100 transition-opacity ml-1">&times;</button>
                    </span>
                    {% else %}
                    <span class="text-sm text-notion-text-muted">등록된 노선이 없습니다.</span>
                    {% endfor %}
                </div>
            </div>

            <!-- 좌석 버스 -->
            <div class="mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <span class="px-2 py-0.5 bg-red-500 text-white text-xs font-medium rounded">좌석</span>
                </div>
                <div class="flex flex-wrap gap-1">
                    {% for route in routes_by_type['좌석'] %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-notion-sidebar text-sm rounded group">
                        {{ route.name }}
                        <button onclick="deleteRoute({{ route.id }})"
                                class="text-red-500 opacity-0 group-hover:opacity-100 transition-opacity ml-1">&times;</button>
                    </span>
                    {% else %}
                    <span class="text-sm text-notion-text-muted">등록된 노선이 없습니다.</span>
                    {% endfor %}
                </div>
            </div>

            <!-- 마을 버스 -->
            <div>
                <div class="flex items-center gap-2 mb-2">
                    <span class="px-2 py-0.5 bg-green-600 text-white text-xs font-medium rounded">마을</span>
                </div>
                <div class="flex flex-wrap gap-1">
                    {% for route in routes_by_type['마을'] %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-notion-sidebar text-sm rounded group">
                        {{ route.name }}
                        <button onclick="deleteRoute({{ route.id }})"
                                class="text-red-500 opacity-0 group-hover:opacity-100 transition-opacity ml-1">&times;</button>
                    </span>
                    {% else %}
                    <span class="text-sm text-notion-text-muted">등록된 노선이 없습니다.</span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<p class="text-xs text-notion-text-muted mt-4">정류장은 드래그하여 순서를 변경할 수 있습니다.</p>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// 정류장 순서 변경
const stopsList = document.getElementById('bus-stops-list');
if (stopsList && stopsList.children.length > 0 && stopsList.querySelector('[data-id]')) {
    new Sortable(stopsList, {
        animation: 150,
        handle: '.drag-handle',
        onEnd: function() {
            const order = [...stopsList.querySelectorAll('[data-id]')].map(el => el.dataset.id);
            fetch('{{ url_for("admin.transportation_reorder_stops") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order })
            });
        }
    });
}

function deleteStop(id) {
    if (confirm('정류장을 삭제하시겠습니까?')) {
        fetch(`/transportation/stops/${id}/delete`, { method: 'POST' })
            .then(res => {
                if (!res.ok) throw new Error('삭제 실패');
                location.reload();
            })
            .catch(err => {
                console.error('삭제 오류:', err);
                alert('삭제 중 오류가 발생했습니다.');
            });
    }
}

function deleteRoute(id) {
    if (confirm('버스 노선을 삭제하시겠습니까?')) {
        fetch(`/transportation/routes/${id}/delete`, { method: 'POST' })
            .then(res => {
                if (!res.ok) throw new Error('삭제 실패');
                location.reload();
            })
            .catch(err => {
                console.error('삭제 오류:', err);
                alert('삭제 중 오류가 발생했습니다.');
            });
    }
}
</script>
{% endblock %}
