{% extends 'admin/base.html' %}

{% block title %}ì—°í˜ ê´€ë¦¬{% endblock %}

{% block breadcrumb %}
<span class="text-notion-text-secondary">ì‚¬ì´íŠ¸ ì„¤ì •</span>
<span class="mx-2 text-notion-text-muted">/</span>
<span class="text-notion-text font-medium">ì—°í˜</span>
{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-xl font-semibold text-notion-text">ì—°í˜ ê´€ë¦¬</h1>
        <p class="text-sm text-notion-text-muted mt-1">"ê±¸ì–´ì˜¨ ê¸¸" í˜ì´ì§€ì— í‘œì‹œë˜ëŠ” ì—°í˜ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
    </div>
    <a href="{{ url_for('admin.history_section_new') }}" class="btn-notion btn-primary">+ ì„¹ì…˜ ì¶”ê°€</a>
</div>

<div class="space-y-6">
    {% for section in sections %}
    <div class="card-notion overflow-hidden">
        <div class="p-4 bg-notion-sidebar border-b border-notion-border flex items-center justify-between">
            <div>
                <h2 class="font-semibold text-notion-text">{{ section.subtitle or 'ì œëª© ì—†ìŒ' }}</h2>
                {% if section.summary_title %}
                <p class="text-sm text-notion-text-muted">{{ section.summary_title }}</p>
                {% endif %}
            </div>
            <div class="flex items-center gap-2">
                <a href="{{ url_for('admin.history_item_new', section_id=section.id) }}" class="btn-notion btn-secondary text-sm">+ í•­ëª© ì¶”ê°€</a>
                <a href="{{ url_for('admin.history_section_edit', id=section.id) }}" class="btn-notion btn-secondary text-sm">ì„¹ì…˜ ìˆ˜ì •</a>
                <button onclick="deleteSection({{ section.id }})" class="btn-notion btn-danger text-sm">ì‚­ì œ</button>
            </div>
        </div>

        {% if section.summary %}
        <div class="p-4 bg-blue-50 border-b border-blue-100 text-sm text-blue-800">
            {{ section.summary }}
        </div>
        {% endif %}

        <table class="table-notion">
            <thead>
                <tr>
                    <th class="w-10"></th>
                    <th class="w-20">ì—°ë„</th>
                    <th>ë‚´ìš©</th>
                    <th class="w-24 text-center">ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody class="sortable-items">
                {% for item in section.items|sort(attribute='display_order') %}
                <tr data-id="{{ item.id }}">
                    <td class="cursor-move text-notion-text-muted text-center">â‹®â‹®</td>
                    <td class="font-medium text-notion-accent">{{ item.year or '-' }}</td>
                    <td>{{ item.content }}</td>
                    <td class="text-center">
                        <a href="{{ url_for('admin.history_item_edit', id=item.id) }}" class="text-xs text-blue-600 hover:underline">ìˆ˜ì •</a>
                        <span class="text-notion-text-muted mx-1">|</span>
                        <button onclick="deleteItem({{ item.id }})" class="text-xs text-red-600 hover:underline">ì‚­ì œ</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="text-center py-8 text-notion-text-muted">
                        ì´ ì„¹ì…˜ì— í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.
                        <a href="{{ url_for('admin.history_item_new', section_id=section.id) }}" class="text-notion-accent hover:underline ml-2">+ í•­ëª© ì¶”ê°€</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p class="text-xs text-notion-text-muted p-3 border-t border-notion-border">ğŸ’¡ í–‰ì„ ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
    {% else %}
    <div class="card-notion p-12 text-center text-notion-text-muted">
        ë“±ë¡ëœ ì—°í˜ ì„¹ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.
        <a href="{{ url_for('admin.history_section_new') }}" class="text-notion-accent hover:underline ml-2">+ ì²« ë²ˆì§¸ ì„¹ì…˜ ì¶”ê°€</a>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// ê° ì„¹ì…˜ì˜ tbodyì— Sortable ì ìš©
document.querySelectorAll('.sortable-items').forEach(tbody => {
    new Sortable(tbody, {
        animation: 150,
        handle: 'td:first-child',
        onEnd: function() {
            const order = [...tbody.querySelectorAll('tr[data-id]')].map(row => row.dataset.id);
            fetch('{{ url_for("admin.history_items_reorder") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order })
            });
        }
    });
});

function deleteSection(id) {
    if (confirm('ì´ ì„¹ì…˜ê³¼ í¬í•¨ëœ ëª¨ë“  í•­ëª©ì´ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        fetch(`/history/sections/${id}/delete`, { method: 'POST' })
            .then(res => {
                if (!res.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
                location.reload();
            })
            .catch(err => {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', err);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    }
}

function deleteItem(id) {
    if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        fetch(`/history/items/${id}/delete`, { method: 'POST' })
            .then(res => {
                if (!res.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
                location.reload();
            })
            .catch(err => {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', err);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    }
}
</script>
{% endblock %}
