{% extends 'admin/base.html' %}

{% block title %}{{ 'ì†Œì‹ì§€ ìˆ˜ì •' if newsletter else 'ìƒˆ ì†Œì‹ì§€' }}{% endblock %}

{% block breadcrumb %}
<span class="text-notion-text-secondary">ì½˜í…ì¸  ê´€ë¦¬</span>
<span class="mx-2 text-notion-text-muted">/</span>
<a href="{{ url_for('admin.newsletters_list') }}" class="text-notion-text-secondary hover:text-notion-accent">ì†Œì‹ì§€</a>
<span class="mx-2 text-notion-text-muted">/</span>
<span class="text-notion-text font-medium">{{ 'ìˆ˜ì •' if newsletter else 'ìƒˆ ì†Œì‹ì§€' }}</span>
{% endblock %}

{% block content %}
<div class="max-w-4xl" x-data="newsletterForm()">
    <!-- í¬ë¡¤ë§ ì„¹ì…˜ (ìƒˆ ë“±ë¡ ì‹œì—ë§Œ) -->
    {% if not newsletter %}
    <div class="card-notion mb-6 p-5 bg-gradient-to-r from-purple-50 to-blue-50 border-purple-200">
        <h3 class="font-medium text-notion-text mb-3 flex items-center gap-2">
            <span>ğŸ”—</span> Stibeeì—ì„œ ê°€ì ¸ì˜¤ê¸°
        </h3>
        <div class="flex gap-3">
            <input type="url" x-model="crawlUrl"
                   placeholder="https://stibee.com/api/v1.0/emails/share/..."
                   class="input-notion flex-1">
            <button type="button" @click="crawlContent()"
                    :disabled="crawling"
                    class="btn-notion btn-primary whitespace-nowrap">
                <span x-show="!crawling">ìë™ ê°€ì ¸ì˜¤ê¸°</span>
                <span x-show="crawling">ê°€ì ¸ì˜¤ëŠ” ì¤‘...</span>
            </button>
        </div>
        <p x-show="crawlError" x-text="crawlError" class="text-sm text-red-500 mt-2"></p>
        <p x-show="crawlSuccess" class="text-sm text-green-600 mt-2">âœ“ ë‚´ìš©ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!</p>
    </div>
    {% endif %}

    <!-- í¼ -->
    <form method="POST">
        <!-- í—¤ë” -->
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-xl font-semibold text-notion-text">
                {{ 'ì†Œì‹ì§€ ìˆ˜ì •' if newsletter else 'ìƒˆ ì†Œì‹ì§€' }}
            </h1>
            <div class="flex items-center gap-3">
                <a href="{{ url_for('admin.newsletters_list') }}" class="btn-notion btn-secondary">ì·¨ì†Œ</a>
                <button type="submit" class="btn-notion btn-primary">ì €ì¥</button>
            </div>
        </div>

        <div class="grid md:grid-cols-3 gap-6">
            <!-- ë©”ì¸ -->
            <div class="md:col-span-2 space-y-6">
                <!-- ì œëª© -->
                <div>
                    <label class="block text-sm font-medium text-notion-text mb-2">ì œëª©</label>
                    <input type="text" name="title" x-model="title"
                           required placeholder="ì†Œì‹ì§€ ì œëª©"
                           class="input-notion text-lg">
                </div>

                <!-- ì„¤ëª… -->
                <div>
                    <label class="block text-sm font-medium text-notion-text mb-2">ì„¤ëª… (ìš”ì•½)</label>
                    <textarea name="description" x-model="description" rows="3"
                              placeholder="ì†Œì‹ì§€ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…"
                              class="input-notion"></textarea>
                </div>

                <!-- HTML ì½˜í…ì¸  -->
                <div>
                    <label class="block text-sm font-medium text-notion-text mb-2">
                        HTML ì½˜í…ì¸ 
                        <span class="text-notion-text-muted font-normal">(ì„ íƒì‚¬í•­)</span>
                    </label>
                    <textarea name="html_content" x-model="htmlContent" rows="10"
                              placeholder="ì†Œì‹ì§€ HTML ë‚´ìš© (Stibeeì—ì„œ ìë™ ê°€ì ¸ì˜¤ê¸° ì‚¬ìš© ì‹œ ìë™ ì…ë ¥ë©ë‹ˆë‹¤)"
                              class="input-notion font-mono text-sm"></textarea>
                    <p class="text-xs text-notion-text-muted mt-1">
                        HTMLì„ ì…ë ¥í•˜ë©´ ì‚¬ì´íŠ¸ì—ì„œ ì†Œì‹ì§€ ë‚´ìš©ì„ ì§ì ‘ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
            </div>

            <!-- ì‚¬ì´ë“œë°” -->
            <div class="space-y-6">
                <!-- ë°œí–‰ì¼ -->
                <div class="card-notion p-4">
                    <label class="block text-sm font-medium text-notion-text mb-2">ë°œí–‰ì¼</label>
                    <input type="date" name="published_at" x-model="publishedAt"
                           class="input-notion">
                </div>

                <!-- ì›ë³¸ URL -->
                <div class="card-notion p-4">
                    <label class="block text-sm font-medium text-notion-text mb-2">ì›ë³¸ URL</label>
                    <input type="url" name="external_url" x-model="externalUrl"
                           placeholder="https://stibee.com/..."
                           class="input-notion text-sm">
                    <p class="text-xs text-notion-text-muted mt-1">
                        Stibee ë“± ì™¸ë¶€ ë§í¬
                    </p>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function newsletterForm() {
    return {
        crawlUrl: '',
        crawling: false,
        crawlError: '',
        crawlSuccess: false,

        // í¼ í•„ë“œ
        title: {{ (newsletter.title if newsletter and newsletter.title else "")|tojson }},
        description: {{ (newsletter.description if newsletter and newsletter.description else "")|tojson }},
        htmlContent: {{ (newsletter.html_content if newsletter and newsletter.html_content else "")|tojson }},
        publishedAt: {{ (newsletter.published_at.strftime("%Y-%m-%d") if newsletter and newsletter.published_at else "")|tojson }},
        externalUrl: {{ (newsletter.external_url if newsletter and newsletter.external_url else "")|tojson }},

        async crawlContent() {
            if (!this.crawlUrl) {
                this.crawlError = 'URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }

            this.crawling = true;
            this.crawlError = '';
            this.crawlSuccess = false;

            try {
                const response = await fetch('/newsletters/crawl', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: this.crawlUrl })
                });

                const data = await response.json();

                if (data.error) {
                    this.crawlError = data.error;
                } else {
                    // ë°ì´í„° ì±„ìš°ê¸°
                    if (data.title) this.title = data.title;
                    if (data.description) this.description = data.description;
                    if (data.html_content) this.htmlContent = data.html_content;
                    if (data.published_at) this.publishedAt = data.published_at;
                    this.externalUrl = this.crawlUrl;

                    this.crawlSuccess = true;
                }
            } catch (e) {
                this.crawlError = 'í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            } finally {
                this.crawling = false;
            }
        }
    };
}
</script>
{% endblock %}
