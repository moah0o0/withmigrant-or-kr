{% extends 'admin/base.html' %}

{% block title %}ì†Œì‹ì§€ ê´€ë¦¬{% endblock %}

{% block breadcrumb %}
<span class="text-notion-text-secondary">ì½˜í…ì¸  ê´€ë¦¬</span>
<span class="mx-2 text-notion-text-muted">/</span>
<span class="text-notion-text font-medium">ì†Œì‹ì§€</span>
{% endblock %}

{% block content %}
<!-- í—¤ë” -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-xl font-semibold text-notion-text">ì†Œì‹ì§€</h1>
        <p class="text-sm text-notion-text-muted mt-1">ì´ {{ pagination.total }}ê°œ</p>
    </div>
    <a href="{{ url_for('admin.newsletters_new') }}" class="btn-notion btn-primary">
        + ìƒˆ ì†Œì‹ì§€
    </a>
</div>

<!-- ì•ˆë‚´ -->
<div class="card-notion mb-6 p-4 bg-blue-50 border-blue-200">
    <div class="flex items-start gap-3">
        <span class="text-lg">ğŸ’¡</span>
        <div class="text-sm text-blue-800">
            <strong>Stibee ì†Œì‹ì§€ URL</strong>ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ë‚´ìš©ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            ìƒˆ ì†Œì‹ì§€ ë“±ë¡ ì‹œ í¬ë¡¤ë§ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”!
        </div>
    </div>
</div>

<!-- ëª©ë¡ -->
<div class="grid gap-4">
    {% for newsletter in pagination.items %}
    <div id="newsletter-{{ newsletter.id }}" class="card-notion p-5 hover:shadow-md transition-shadow">
        <div class="flex items-start gap-4">
            <!-- ì•„ì´ì½˜ -->
            <div class="flex-shrink-0 w-14 h-14 rounded-lg bg-purple-100 flex items-center justify-center">
                <span class="text-lg">ğŸ“¬</span>
            </div>

            <!-- ì •ë³´ -->
            <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <h3 class="font-medium text-notion-text">
                            <a href="{{ url_for('admin.newsletters_edit', id=newsletter.id) }}"
                               class="hover:text-notion-accent">
                                {{ newsletter.title }}
                            </a>
                        </h3>
                        {% if newsletter.description %}
                        <p class="text-sm text-notion-text-secondary mt-1 line-clamp-2">
                            {{ newsletter.description }}
                        </p>
                        {% endif %}
                        <div class="flex items-center gap-3 mt-2 text-xs text-notion-text-muted">
                            <span>{{ newsletter.published_at.strftime('%Y.%m.%d') if newsletter.published_at else newsletter.created_at.strftime('%Y.%m.%d') if newsletter.created_at else '' }}</span>
                            {% if newsletter.external_url %}
                            <a href="{{ newsletter.external_url }}" target="_blank" class="text-notion-accent hover:underline">
                                ì›ë³¸ ë³´ê¸° â†—
                            </a>
                            {% endif %}
                            <span class="px-2 py-0.5 bg-notion-sidebar rounded text-notion-text-secondary">
                                {{ 'HTML' if newsletter.content_type == 'html' else 'PDF' }}
                            </span>
                        </div>
                    </div>

                    <!-- ì•¡ì…˜ -->
                    <div class="flex items-center gap-2">
                        <a href="{{ url_for('admin.newsletters_edit', id=newsletter.id) }}"
                           class="btn-notion btn-secondary text-xs">ìˆ˜ì •</a>
                        <button onclick="deleteNewsletter({{ newsletter.id }})"
                                class="btn-notion btn-danger text-xs">ì‚­ì œ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card-notion p-12 text-center">
        <div class="text-4xl mb-4">ğŸ“¬</div>
        <p class="text-notion-text-muted">ë“±ë¡ëœ ì†Œì‹ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        <a href="{{ url_for('admin.newsletters_new') }}" class="inline-block mt-4 btn-notion btn-primary">
            ì²« ì†Œì‹ì§€ ë“±ë¡í•˜ê¸°
        </a>
    </div>
    {% endfor %}
</div>

<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
{% if pagination.pages > 1 %}
<div class="flex items-center justify-center gap-2 mt-6">
    {% if pagination.has_prev %}
    <a href="{{ url_for('admin.newsletters_list', page=pagination.prev_num) }}"
       class="btn-notion btn-secondary">â† ì´ì „</a>
    {% endif %}

    <span class="text-sm text-notion-text-secondary px-4">
        {{ pagination.page }} / {{ pagination.pages }}
    </span>

    {% if pagination.has_next %}
    <a href="{{ url_for('admin.newsletters_list', page=pagination.next_num) }}"
       class="btn-notion btn-secondary">ë‹¤ìŒ â†’</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function deleteNewsletter(id) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    fetch(`/newsletters/${id}/delete`, {
        method: 'POST',
        headers: { 'HX-Request': 'true' }
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`ì‚­ì œ ì‹¤íŒ¨ (${res.status})`);
        }
        return res;
    })
    .then(() => {
        document.getElementById(`newsletter-${id}`).remove();
    })
    .catch(err => {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
    });
}
</script>
{% endblock %}
