{% extends 'admin/base.html' %}

{% block title %}ê³µì§€ì‚¬í•­ ê´€ë¦¬{% endblock %}

{% block breadcrumb %}
<span class="text-notion-text-secondary">ì½˜í…ì¸  ê´€ë¦¬</span>
<span class="mx-2 text-notion-text-muted">/</span>
<span class="text-notion-text font-medium">ê³µì§€ì‚¬í•­</span>
{% endblock %}

{% block content %}
<!-- í—¤ë” -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-xl font-semibold text-notion-text">ê³µì§€ì‚¬í•­</h1>
        <p class="text-sm text-notion-text-muted mt-1">ì´ {{ pagination.total }}ê°œ</p>
    </div>
    <a href="{{ url_for('admin.notices_new') }}" class="btn-notion btn-primary">
        + ìƒˆ ê³µì§€ì‚¬í•­
    </a>
</div>

<!-- ê²€ìƒ‰ -->
<div class="card-notion mb-6">
    <form method="GET" class="p-4 flex gap-3">
        <input type="text" name="q" value="{{ q }}" placeholder="ì œëª©ìœ¼ë¡œ ê²€ìƒ‰..."
               class="input-notion flex-1">
        <button type="submit" class="btn-notion btn-secondary">ê²€ìƒ‰</button>
        {% if q %}
        <a href="{{ url_for('admin.notices_list') }}" class="btn-notion btn-secondary">ì´ˆê¸°í™”</a>
        {% endif %}
    </form>
</div>

<!-- ëª©ë¡ -->
<div class="card-notion overflow-hidden">
    <div class="table-scroll">
    <table class="table-notion min-w-[600px]">
        <thead>
            <tr>
                <th class="w-16">ê³ ì •</th>
                <th>ì œëª©</th>
                <th class="w-28 text-center">ì‘ì„±ì¼</th>
                <th class="w-20 text-center">ì¡°íšŒ</th>
                <th class="w-32 text-center">ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody>
            {% for notice in pagination.items %}
            <tr id="notice-{{ notice.id }}">
                <td class="text-center">
                    <button onclick="togglePin({{ notice.id }})"
                            class="pin-btn text-lg opacity-50 hover:opacity-100 transition-opacity"
                            data-pinned="{{ 'true' if notice.is_pinned else 'false' }}">
                        {{ 'ğŸ“Œ' if notice.is_pinned else 'ğŸ“' }}
                    </button>
                </td>
                <td>
                    <a href="{{ url_for('admin.notices_edit', id=notice.id) }}"
                       class="hover:text-notion-accent transition-colors">
                        {% if notice.is_pinned %}
                        <span class="text-xs bg-notion-accent text-white px-1.5 py-0.5 rounded mr-2">ê³ ì •</span>
                        {% endif %}
                        {{ notice.title }}
                    </a>
                </td>
                <td class="text-center text-notion-text-secondary text-sm">
                    {{ notice.created_at.strftime('%Y.%m.%d') if notice.created_at else '-' }}
                </td>
                <td class="text-center text-notion-text-secondary text-sm">
                    {{ notice.view_count or 0 }}
                </td>
                <td class="text-center">
                    <div class="flex items-center justify-center gap-2">
                        <a href="{{ url_for('admin.notices_edit', id=notice.id) }}"
                           class="text-xs text-notion-accent hover:underline">ìˆ˜ì •</a>
                        <button onclick="deleteNotice({{ notice.id }})"
                                class="text-xs text-red-500 hover:underline">ì‚­ì œ</button>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" class="text-center py-12 text-notion-text-muted">
                    ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>

<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
{% if pagination.pages > 1 %}
<div class="flex items-center justify-center gap-2 mt-6">
    {% if pagination.has_prev %}
    <a href="{{ url_for('admin.notices_list', page=pagination.prev_num, q=q) }}"
       class="btn-notion btn-secondary">â† ì´ì „</a>
    {% endif %}

    <span class="text-sm text-notion-text-secondary px-4">
        {{ pagination.page }} / {{ pagination.pages }}
    </span>

    {% if pagination.has_next %}
    <a href="{{ url_for('admin.notices_list', page=pagination.next_num, q=q) }}"
       class="btn-notion btn-secondary">ë‹¤ìŒ â†’</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function togglePin(id) {
    fetch(`/notices/${id}/toggle-pin`, {
        method: 'POST',
        headers: { 'HX-Request': 'true' }
    })
    .then(res => {
        if (!res.ok) {
            return res.text().then(text => {
                throw new Error(`ê³ ì • í† ê¸€ ì‹¤íŒ¨ (${res.status}): ${text}`);
            });
        }
        return res.json();
    })
    .then(data => {
        location.reload();
    })
    .catch(err => {
        console.error('í† ê¸€ ì˜¤ë¥˜:', err);
        alert('ê³ ì • í† ê¸€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
    });
}

function deleteNotice(id) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    fetch(`/notices/${id}/delete`, {
        method: 'POST',
        headers: { 'HX-Request': 'true' }
    })
    .then(res => {
        if (!res.ok) {
            return res.text().then(text => {
                throw new Error(`ì‚­ì œ ì‹¤íŒ¨ (${res.status}): ${text}`);
            });
        }
        return res;
    })
    .then(() => {
        document.getElementById(`notice-${id}`).remove();
    })
    .catch(err => {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
    });
}
</script>
{% endblock %}
