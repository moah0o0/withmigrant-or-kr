{% extends 'admin/base.html' %}

{% block title %}í™œë™í›„ê¸° ê´€ë¦¬{% endblock %}

{% block breadcrumb %}
<span class="text-notion-text-secondary">ì½˜í…ì¸  ê´€ë¦¬</span>
<span class="mx-2 text-notion-text-muted">/</span>
<span class="text-notion-text font-medium">í™œë™í›„ê¸°</span>
{% endblock %}

{% block content %}
<!-- í—¤ë” -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-xl font-semibold text-notion-text">í™œë™í›„ê¸°</h1>
        <p class="text-sm text-notion-text-muted mt-1">ì´ {{ pagination.total }}ê°œ</p>
    </div>
    <a href="{{ url_for('admin.activities_new') }}" class="btn-notion btn-primary">
        + ìƒˆ í™œë™í›„ê¸°
    </a>
</div>

<!-- í•„í„° & ê²€ìƒ‰ -->
<div class="card-notion mb-6">
    <form method="GET" class="p-4">
        <div class="flex flex-wrap gap-3">
            <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
            <select name="category" onchange="this.form.submit()"
                    class="input-notion w-auto">
                <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                <option value="__none__" {{ 'selected' if current_category == '__none__' else '' }}>ì¹´í…Œê³ ë¦¬ ì—†ìŒ</option>
                {% for cat in categories %}
                <option value="{{ cat.name }}" {{ 'selected' if current_category == cat.name else '' }}>
                    {{ cat.name }}
                </option>
                {% endfor %}
            </select>

            <!-- ê²€ìƒ‰ -->
            <div class="flex gap-2 flex-1">
                <input type="text" name="q" value="{{ q }}" placeholder="ì œëª©ìœ¼ë¡œ ê²€ìƒ‰..."
                       class="input-notion flex-1">
                <button type="submit" class="btn-notion btn-secondary">ê²€ìƒ‰</button>
                {% if q or current_category %}
                <a href="{{ url_for('admin.activities_list') }}" class="btn-notion btn-secondary">ì´ˆê¸°í™”</a>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<!-- ëª©ë¡ -->
<div class="card-notion overflow-hidden">
    <div class="table-scroll">
    <table class="table-notion min-w-[700px]">
        <thead>
            <tr>
                <th class="w-20">ì¸ë„¤ì¼</th>
                <th>ì œëª©</th>
                <th class="w-28">ì¹´í…Œê³ ë¦¬</th>
                <th class="w-28 text-center">ì‘ì„±ì¼</th>
                <th class="w-20 text-center">ì¡°íšŒ</th>
                <th class="w-32 text-center">ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody>
            {% for activity in pagination.items %}
            <tr id="activity-{{ activity.id }}">
                <td>
                    {% if activity.image_url %}
                    <img src="{{ activity.image_url }}" alt="" class="w-16 h-12 rounded object-cover">
                    {% else %}
                    <div class="w-16 h-12 rounded bg-notion-sidebar flex items-center justify-center text-lg">ğŸ“</div>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('admin.activities_edit', id=activity.id) }}"
                       class="hover:text-notion-accent transition-colors font-medium">
                        {{ activity.title }}
                    </a>
                    {% if activity.content %}
                    <p class="text-xs text-notion-text-muted mt-1 line-clamp-1">
                        {{ activity.content|striptags|truncate(50) }}
                    </p>
                    {% endif %}
                </td>
                <td>
                    {% if activity.category %}
                    {% set cat_color = '#6d28d9' %}
                    {% for c in all_categories %}{% if c.name == activity.category %}{% set cat_color = c.color %}{% endif %}{% endfor %}
                    <span class="inline-block px-2 py-1 text-xs text-white rounded"
                          style="background-color: {{ cat_color }}">
                        {{ activity.category }}
                    </span>
                    {% else %}
                    <span class="text-notion-text-muted text-sm">-</span>
                    {% endif %}
                </td>
                <td class="text-center text-notion-text-secondary text-sm">
                    {{ activity.created_at.strftime('%Y.%m.%d') if activity.created_at else '-' }}
                </td>
                <td class="text-center text-notion-text-secondary text-sm">
                    {{ activity.view_count or 0 }}
                </td>
                <td class="text-center">
                    <div class="flex items-center justify-center gap-2">
                        <a href="{{ url_for('admin.activities_edit', id=activity.id) }}"
                           class="text-xs text-notion-accent hover:underline">ìˆ˜ì •</a>
                        <button onclick="deleteActivity({{ activity.id }})"
                                class="text-xs text-red-500 hover:underline">ì‚­ì œ</button>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="text-center py-12 text-notion-text-muted">
                    ë“±ë¡ëœ í™œë™í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>

<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
{% if pagination.pages > 1 %}
<div class="flex items-center justify-center gap-2 mt-6">
    {% if pagination.has_prev %}
    <a href="{{ url_for('admin.activities_list', page=pagination.prev_num, q=q, category=current_category) }}"
       class="btn-notion btn-secondary">â† ì´ì „</a>
    {% endif %}

    <span class="text-sm text-notion-text-secondary px-4">
        {{ pagination.page }} / {{ pagination.pages }}
    </span>

    {% if pagination.has_next %}
    <a href="{{ url_for('admin.activities_list', page=pagination.next_num, q=q, category=current_category) }}"
       class="btn-notion btn-secondary">ë‹¤ìŒ â†’</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function deleteActivity(id) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    fetch(`/activities/${id}/delete`, {
        method: 'POST',
        headers: { 'HX-Request': 'true' }
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`ì‚­ì œ ì‹¤íŒ¨ (${res.status})`);
        }
        return res;
    })
    .then(() => {
        document.getElementById(`activity-${id}`).remove();
    })
    .catch(err => {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
    });
}
</script>
{% endblock %}
