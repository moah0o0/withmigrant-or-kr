{% extends 'admin/base.html' %}

{% block title %}ì¹´í…Œê³ ë¦¬ ê´€ë¦¬{% endblock %}

{% block breadcrumb %}
<span class="text-notion-text-secondary">ì‚¬ì´íŠ¸ ì„¤ì •</span>
<span class="mx-2 text-notion-text-muted">/</span>
<span class="text-notion-text font-medium">ì¹´í…Œê³ ë¦¬</span>
{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-xl font-semibold text-notion-text">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h1>
        <p class="text-sm text-notion-text-muted mt-1">í™œë™í›„ê¸° ë¶„ë¥˜ì— ì‚¬ìš©ë˜ëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
    </div>
    <div class="flex items-center gap-3">
        {% if categories|length > 1 %}
        <button onclick="openMergeModal()" class="btn-notion btn-secondary">ì¹´í…Œê³ ë¦¬ ë³‘í•©</button>
        {% endif %}
        <a href="{{ url_for('admin.categories_new') }}" class="btn-notion btn-primary">+ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</a>
    </div>
</div>

<div class="card-notion overflow-hidden">
    <table class="table-notion">
        <thead>
            <tr>
                <th class="w-12"></th>
                <th>ì´ë¦„</th>
                <th class="w-20 text-center">ê²Œì‹œë¬¼</th>
                <th class="w-24">ìƒ‰ìƒ</th>
                <th class="w-20 text-center">ìƒíƒœ</th>
                <th class="w-32 text-center">ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="sortable-list">
            {% for category in categories %}
            <tr data-id="{{ category.id }}">
                <td class="cursor-move text-notion-text-muted">â‹®â‹®</td>
                <td>
                    <div class="flex items-center gap-3">
                        <span class="w-4 h-4 rounded" style="background-color: {{ category.color }}"></span>
                        <span class="font-medium text-notion-text">{{ category.name }}</span>
                    </div>
                </td>
                <td class="text-center">
                    <span class="text-sm text-notion-text-secondary">{{ post_counts.get(category.id, 0) }}ê°œ</span>
                </td>
                <td>
                    <code class="text-xs bg-notion-sidebar px-2 py-1 rounded">{{ category.color }}</code>
                </td>
                <td class="text-center">
                    {% if category.is_active %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-green-700 bg-green-100 rounded">í™œì„±</span>
                    {% else %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-gray-500 bg-gray-100 rounded">ë¹„í™œì„±</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    <div class="flex items-center justify-center gap-2">
                        <a href="{{ url_for('admin.categories_edit', id=category.id) }}" class="text-xs text-blue-600 hover:underline">ìˆ˜ì •</a>
                        <span class="text-notion-text-muted">|</span>
                        <button onclick="deleteCategory({{ category.id }})" class="text-xs text-red-600 hover:underline">ì‚­ì œ</button>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="text-center py-12 text-notion-text-muted">
                    ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<p class="text-xs text-notion-text-muted mt-4">ğŸ’¡ í–‰ì„ ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<!-- ë³‘í•© ëª¨ë‹¬ -->
<div id="mergeModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
        <h3 class="text-lg font-semibold text-notion-text mb-4">ì¹´í…Œê³ ë¦¬ ë³‘í•©</h3>
        <p class="text-sm text-notion-text-muted mb-4">ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  ê²Œì‹œë¬¼ì„ ëŒ€ìƒ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•˜ê³ , ì›ë³¸ ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.</p>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-notion-text mb-2">ë³‘í•©í•  ì¹´í…Œê³ ë¦¬ (ì‚­ì œë¨)</label>
                <select id="sourceCategory" class="input-notion">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" data-name="{{ category.name }}" data-count="{{ post_counts.get(category.id, 0) }}">
                        {{ category.name }} ({{ post_counts.get(category.id, 0) }}ê°œ)
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="text-center text-notion-text-muted">â†“</div>
            <div>
                <label class="block text-sm font-medium text-notion-text mb-2">ëŒ€ìƒ ì¹´í…Œê³ ë¦¬ (ìœ ì§€ë¨)</label>
                <select id="targetCategory" class="input-notion">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" data-name="{{ category.name }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeMergeModal()" class="btn-notion btn-secondary">ì·¨ì†Œ</button>
            <button onclick="mergeCategories()" class="btn-notion btn-danger">ë³‘í•©</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
new Sortable(document.getElementById('sortable-list'), {
    animation: 150,
    handle: 'td:first-child',
    onEnd: function() {
        const order = [...document.querySelectorAll('#sortable-list tr[data-id]')].map(row => row.dataset.id);
        fetch('{{ url_for("admin.categories_reorder") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order })
        })
        .then(res => {
            if (!res.ok) {
                throw new Error('ì¬ì •ë ¬ ì €ì¥ ì‹¤íŒ¨');
            }
        })
        .catch(err => {
            console.error('ì¬ì •ë ¬ ì˜¤ë¥˜:', err);
            alert('ìˆœì„œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
            location.reload();
        });
    }
});

function deleteCategory(id) {
    if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ê²Œì‹œë¬¼ë“¤ì€ ë¯¸ë¶„ë¥˜ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.')) {
        fetch(`/categories/${id}/delete`, { method: 'POST' })
            .then(res => {
                if (!res.ok) {
                    return res.text().then(text => {
                        throw new Error(`ì‚­ì œ ì‹¤íŒ¨ (${res.status}): ${text}`);
                    });
                }
                return res;
            })
            .then(() => location.reload())
            .catch(err => {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', err);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            });
    }
}

function openMergeModal() {
    document.getElementById('mergeModal').classList.remove('hidden');
    document.getElementById('sourceCategory').value = '';
    document.getElementById('targetCategory').value = '';
}

function closeMergeModal() {
    document.getElementById('mergeModal').classList.add('hidden');
}

function mergeCategories() {
    const sourceId = document.getElementById('sourceCategory').value;
    const targetId = document.getElementById('targetCategory').value;

    if (!sourceId || !targetId) {
        alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    if (sourceId === targetId) {
        alert('ê°™ì€ ì¹´í…Œê³ ë¦¬ë¼ë¦¬ëŠ” ë³‘í•©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const sourceName = document.getElementById('sourceCategory').selectedOptions[0].dataset.name;
    const targetName = document.getElementById('targetCategory').selectedOptions[0].dataset.name;
    const postCount = document.getElementById('sourceCategory').selectedOptions[0].dataset.count;

    if (!confirm(`"${sourceName}" ì¹´í…Œê³ ë¦¬ì˜ ${postCount}ê°œ ê²Œì‹œë¬¼ì„ "${targetName}"(ìœ¼)ë¡œ ì´ë™í•˜ê³ , "${sourceName}" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    fetch('{{ url_for("admin.categories_merge") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ source_id: sourceId, target_id: targetId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.error || 'ë³‘í•©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });
}

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeMergeModal();
});
</script>
{% endblock %}
