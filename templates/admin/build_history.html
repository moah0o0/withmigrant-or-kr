{% extends 'admin/base.html' %}

{% block title %}빌드 히스토리{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('admin.dashboard') }}" class="text-notion-text-secondary hover:text-notion-text">대시보드</a>
<span class="text-notion-text-muted mx-2">/</span>
<span class="text-notion-text font-medium">빌드 히스토리</span>
{% endblock %}

{% block content %}
<div class="mb-6 flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-semibold text-notion-text">빌드 히스토리</h1>
        <p class="text-notion-text-secondary mt-1">SSG 빌드 내역을 확인할 수 있습니다.</p>
    </div>
    <button onclick="manualBuild()" class="btn-notion btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline-block mr-2">
            <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
        수동 빌드
    </button>
</div>

<!-- 현재 빌드 상태 -->
<div id="current-build-status" class="mb-6"></div>

<!-- 빌드 히스토리 테이블 -->
<div class="card-notion overflow-hidden">
    <table class="w-full">
        <thead class="bg-notion-sidebar border-b border-notion-border">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-notion-text-muted uppercase tracking-wider">ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-notion-text-muted uppercase tracking-wider">상태</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-notion-text-muted uppercase tracking-wider">트리거</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-notion-text-muted uppercase tracking-wider">시작 시간</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-notion-text-muted uppercase tracking-wider">소요 시간</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-notion-text-muted uppercase tracking-wider">에러</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-notion-border">
            {% for build in builds %}
            <tr class="hover:bg-notion-sidebar transition-colors">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-notion-text">
                    #{{ build.id }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    {% if build.status == 'building' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <span class="animate-pulse mr-1">●</span> 빌드 중
                    </span>
                    {% elif build.status == 'success' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        ✓ 성공
                    </span>
                    {% elif build.status == 'failed' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        ✗ 실패
                    </span>
                    {% else %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        대기
                    </span>
                    {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-notion-text">
                    <code class="px-2 py-1 bg-notion-sidebar rounded text-xs">{{ build.triggered_by or 'unknown' }}</code>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-notion-text-secondary">
                    {% if build.started_at %}
                        {{ build.started_at.strftime('%Y-%m-%d %H:%M:%S') }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-notion-text">
                    {% if build.completed_at and build.started_at %}
                        {{ "%.1f"|format((build.completed_at - build.started_at).total_seconds()) }}초
                    {% elif build.status == 'building' %}
                        <span class="text-notion-text-muted">진행 중...</span>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="px-6 py-4 text-sm text-notion-text-secondary">
                    {% if build.error_message %}
                        <details class="cursor-pointer">
                            <summary class="text-red-600 hover:text-red-700">에러 보기</summary>
                            <pre class="mt-2 p-2 bg-red-50 rounded text-xs overflow-x-auto">{{ build.error_message }}</pre>
                        </details>
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="px-6 py-8 text-center text-notion-text-muted">
                    빌드 히스토리가 없습니다.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 페이지네이션 -->
{% if pagination.pages > 1 %}
<div class="mt-6 flex items-center justify-between">
    <div class="text-sm text-notion-text-secondary">
        총 {{ pagination.total }}개 빌드 / {{ pagination.pages }}페이지 중 {{ pagination.page }}페이지
    </div>
    <div class="flex gap-2">
        {% if pagination.has_prev %}
        <a href="{{ url_for('admin.build_history', page=pagination.prev_num) }}"
           class="px-4 py-2 border border-notion-border rounded-lg hover:bg-notion-sidebar transition-colors">
            이전
        </a>
        {% endif %}

        {% if pagination.has_next %}
        <a href="{{ url_for('admin.build_history', page=pagination.next_num) }}"
           class="px-4 py-2 border border-notion-border rounded-lg hover:bg-notion-sidebar transition-colors">
            다음
        </a>
        {% endif %}
    </div>
</div>
{% endif %}

<script>
// 수동 빌드 트리거
function manualBuild() {
    if (!confirm('수동으로 빌드를 시작하시겠습니까?')) return;

    fetch('{{ url_for("admin.build_trigger") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('빌드 시작 실패: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('빌드 시작 중 오류가 발생했습니다.');
    });
}

// 현재 빌드 상태 확인
function checkCurrentBuildStatus() {
    fetch('{{ url_for("admin.build_status") }}')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('current-build-status');

            if (data.status === 'building') {
                container.innerHTML = `
                    <div class="card-notion border-l-4 border-l-blue-500 p-4">
                        <div class="flex items-center gap-3">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                            <div>
                                <div class="font-medium text-notion-text">현재 빌드 진행 중...</div>
                                <div class="text-sm text-notion-text-secondary">
                                    빌드 ID: #${data.id} | 트리거: ${data.triggered_by}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                // 5초마다 상태 확인 및 페이지 새로고침
                setTimeout(() => {
                    location.reload();
                }, 5000);
            }
        })
        .catch(error => console.error('빌드 상태 확인 실패:', error));
}

// 페이지 로드 시 현재 빌드 상태 확인
checkCurrentBuildStatus();
</script>

{% endblock %}
