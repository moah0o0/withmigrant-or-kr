{% extends 'admin/base.html' %}

{% block title %}ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block breadcrumb %}
<span class="text-notion-text font-medium">ëŒ€ì‹œë³´ë“œ</span>
{% endblock %}

{% block content %}
<!-- í™˜ì˜ ë©”ì‹œì§€ -->
<div class="mb-8">
    <h1 class="text-2xl font-semibold text-notion-text mb-1">ì•ˆë…•í•˜ì„¸ìš”, {{ admin.name or admin.username }}ë‹˜!</h1>
    <p class="text-notion-text-secondary">ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”.</p>
</div>

<!-- ë¹Œë“œ ìƒíƒœ ì•Œë¦¼ -->
<div id="build-status-container" class="mb-6"></div>

<!-- í†µê³„ ì¹´ë“œ -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    <div class="card-notion p-5">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center">
                <span class="text-lg">ğŸ“¢</span>
            </div>
            <div>
                <div class="text-2xl font-semibold text-notion-text">{{ stats.notices }}</div>
                <div class="text-xs text-notion-text-muted">ê³µì§€ì‚¬í•­</div>
            </div>
        </div>
    </div>

    <div class="card-notion p-5">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center">
                <span class="text-lg">ğŸ“</span>
            </div>
            <div>
                <div class="text-2xl font-semibold text-notion-text">{{ stats.activities }}</div>
                <div class="text-xs text-notion-text-muted">í™œë™í›„ê¸°</div>
            </div>
        </div>
    </div>

    <div class="card-notion p-5">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center">
                <span class="text-lg">ğŸ“¬</span>
            </div>
            <div>
                <div class="text-2xl font-semibold text-notion-text">{{ stats.newsletters }}</div>
                <div class="text-xs text-notion-text-muted">ì†Œì‹ì§€</div>
            </div>
        </div>
    </div>

    <div class="card-notion p-5">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-red-50 flex items-center justify-center">
                <span class="text-lg">ğŸ’</span>
            </div>
            <div>
                <div class="text-2xl font-semibold text-notion-text">{{ stats.donations_pending }}</div>
                <div class="text-xs text-notion-text-muted">ëŒ€ê¸° ì¤‘ í›„ì›</div>
            </div>
        </div>
    </div>
</div>

<!-- ìµœê·¼ ì½˜í…ì¸  -->
<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- ìµœê·¼ ê³µì§€ì‚¬í•­ -->
    <div class="card-notion">
        <div class="p-4 border-b border-notion-border flex items-center justify-between">
            <h2 class="font-medium text-notion-text flex items-center gap-2">
                <span>ğŸ“¢</span> ìµœê·¼ ê³µì§€ì‚¬í•­
            </h2>
            <a href="{{ url_for('admin.notices_new') }}" class="text-xs text-notion-accent hover:underline">+ ìƒˆ ê¸€</a>
        </div>
        <div class="divide-y divide-notion-border">
            {% for notice in recent_notices %}
            <a href="{{ url_for('admin.notices_edit', id=notice.id) }}"
               class="block p-4 hover:bg-notion-sidebar transition-colors">
                <div class="flex items-start gap-2">
                    {% if notice.is_pinned %}
                    <span class="flex-shrink-0 text-xs bg-notion-accent text-white px-1.5 py-0.5 rounded">ê³ ì •</span>
                    {% endif %}
                    <div class="flex-1 min-w-0">
                        <div class="text-sm text-notion-text truncate">{{ notice.title }}</div>
                        <div class="text-xs text-notion-text-muted mt-1">
                            {{ notice.created_at.strftime('%Y.%m.%d') if notice.created_at else '' }}
                        </div>
                    </div>
                </div>
            </a>
            {% else %}
            <div class="p-4 text-sm text-notion-text-muted text-center">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤</div>
            {% endfor %}
        </div>
        <div class="p-3 border-t border-notion-border">
            <a href="{{ url_for('admin.notices_list') }}" class="text-xs text-notion-text-secondary hover:text-notion-accent">
                ì „ì²´ë³´ê¸° â†’
            </a>
        </div>
    </div>

    <!-- ìµœê·¼ í™œë™í›„ê¸° -->
    <div class="card-notion">
        <div class="p-4 border-b border-notion-border flex items-center justify-between">
            <h2 class="font-medium text-notion-text flex items-center gap-2">
                <span>ğŸ“</span> ìµœê·¼ í™œë™í›„ê¸°
            </h2>
            <a href="{{ url_for('admin.activities_new') }}" class="text-xs text-notion-accent hover:underline">+ ìƒˆ ê¸€</a>
        </div>
        <div class="divide-y divide-notion-border">
            {% for activity in recent_activities %}
            <a href="{{ url_for('admin.activities_edit', id=activity.id) }}"
               class="block p-4 hover:bg-notion-sidebar transition-colors">
                <div class="flex items-start gap-3">
                    {% if activity.image_url %}
                    <img src="{{ activity.image_url }}" alt="" class="w-12 h-12 rounded object-cover flex-shrink-0">
                    {% else %}
                    <div class="w-12 h-12 rounded bg-notion-sidebar flex items-center justify-center flex-shrink-0">
                        <span class="text-lg">ğŸ“</span>
                    </div>
                    {% endif %}
                    <div class="flex-1 min-w-0">
                        <div class="text-sm text-notion-text truncate">{{ activity.title }}</div>
                        <div class="text-xs text-notion-text-muted mt-1">
                            {% if activity.category %}<span class="text-notion-accent">{{ activity.category }}</span> Â· {% endif %}
                            {{ activity.created_at.strftime('%Y.%m.%d') if activity.created_at else '' }}
                        </div>
                    </div>
                </div>
            </a>
            {% else %}
            <div class="p-4 text-sm text-notion-text-muted text-center">ë“±ë¡ëœ í™œë™í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            {% endfor %}
        </div>
        <div class="p-3 border-t border-notion-border">
            <a href="{{ url_for('admin.activities_list') }}" class="text-xs text-notion-text-secondary hover:text-notion-accent">
                ì „ì²´ë³´ê¸° â†’
            </a>
        </div>
    </div>

    <!-- ìµœê·¼ ì†Œì‹ì§€ -->
    <div class="card-notion">
        <div class="p-4 border-b border-notion-border flex items-center justify-between">
            <h2 class="font-medium text-notion-text flex items-center gap-2">
                <span>ğŸ“¬</span> ìµœê·¼ ì†Œì‹ì§€
            </h2>
            <a href="{{ url_for('admin.newsletters_new') }}" class="text-xs text-notion-accent hover:underline">+ ìƒˆ ì†Œì‹ì§€</a>
        </div>
        <div class="divide-y divide-notion-border">
            {% for newsletter in recent_newsletters %}
            <a href="{{ url_for('admin.newsletters_edit', id=newsletter.id) }}"
               class="block p-4 hover:bg-notion-sidebar transition-colors">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded bg-purple-50 flex items-center justify-center flex-shrink-0 text-sm">
                        ğŸ“¬
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm text-notion-text truncate">{{ newsletter.title }}</div>
                        <div class="text-xs text-notion-text-muted mt-1">
                            {{ newsletter.published_at.strftime('%Y.%m.%d') if newsletter.published_at else newsletter.created_at.strftime('%Y.%m.%d') if newsletter.created_at else '' }}
                        </div>
                    </div>
                </div>
            </a>
            {% else %}
            <div class="p-4 text-sm text-notion-text-muted text-center">ë“±ë¡ëœ ì†Œì‹ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            {% endfor %}
        </div>
        <div class="p-3 border-t border-notion-border">
            <a href="{{ url_for('admin.newsletters_list') }}" class="text-xs text-notion-text-secondary hover:text-notion-accent">
                ì „ì²´ë³´ê¸° â†’
            </a>
        </div>
    </div>
</div>

<!-- ì²˜ë¦¬ ëŒ€ê¸° ì¤‘ì¸ í›„ì›ì‹ ì²­ -->
{% if stats.donations_pending > 0 %}
<div class="mt-8 card-notion border-l-4 border-l-orange-400">
    <div class="p-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <span class="text-xl">â³</span>
            <div>
                <div class="font-medium text-notion-text">ì²˜ë¦¬ ëŒ€ê¸° ì¤‘ì¸ í›„ì›ì‹ ì²­ì´ ìˆìŠµë‹ˆë‹¤</div>
                <div class="text-sm text-notion-text-secondary">{{ stats.donations_pending }}ê±´ì˜ í›„ì›ì‹ ì²­ì´ í™•ì¸ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”.</div>
            </div>
        </div>
        <a href="{{ url_for('admin.donations_list', status='pending') }}" class="btn-notion btn-primary">
            í™•ì¸í•˜ê¸° â†’
        </a>
    </div>
</div>
{% endif %}

<script>
// ë¹Œë“œ ìƒíƒœ í™•ì¸
function checkBuildStatus() {
    fetch('{{ url_for("admin.build_status") }}')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('build-status-container');

            if (data.status === 'building') {
                container.innerHTML = `
                    <div class="card-notion border-l-4 border-l-blue-500 p-4">
                        <div class="flex items-center gap-3">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                            <div>
                                <div class="font-medium text-notion-text">ğŸ”¨ í™ˆí˜ì´ì§€ ìƒì„± ì¤‘...</div>
                                <div class="text-sm text-notion-text-secondary">
                                    ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                // ë¹Œë“œ ì¤‘ì¼ ë•ŒëŠ” 5ì´ˆë§ˆë‹¤ í™•ì¸
                setTimeout(checkBuildStatus, 5000);
            } else if (data.status === 'success' && data.completed_at) {
                const completedTime = new Date(data.completed_at);
                const now = new Date();
                const diff = (now - completedTime) / 1000; // ì´ˆ ë‹¨ìœ„

                // 30ì´ˆ ì´ë‚´ì— ì™„ë£Œëœ ë¹Œë“œë§Œ í‘œì‹œ
                if (diff < 30) {
                    container.innerHTML = `
                        <div class="card-notion border-l-4 border-l-green-500 p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">âœ…</span>
                                    <div>
                                        <div class="font-medium text-notion-text">í™ˆí˜ì´ì§€ ìƒì„± ì™„ë£Œ!</div>
                                        <div class="text-sm text-notion-text-secondary">
                                            ${data.duration ? data.duration.toFixed(1) + 'ì´ˆ' : ''} ì†Œìš”
                                        </div>
                                    </div>
                                </div>
                                <button onclick="this.parentElement.parentElement.remove()" class="text-notion-text-muted hover:text-notion-text">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 6L6 18M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }
            } else if (data.status === 'failed') {
                container.innerHTML = `
                    <div class="card-notion border-l-4 border-l-red-500 p-4">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">âŒ</span>
                            <div>
                                <div class="font-medium text-notion-text">ë¹Œë“œ ì‹¤íŒ¨</div>
                                <div class="text-sm text-notion-text-secondary">
                                    ${data.error_message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => console.error('ë¹Œë“œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error));
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë¹Œë“œ ìƒíƒœ í™•ì¸
checkBuildStatus();
</script>

{% endblock %}
