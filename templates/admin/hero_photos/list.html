{% extends 'admin/base.html' %}

{% block title %}ë©”ì¸ ì‚¬ì§„ ê´€ë¦¬{% endblock %}

{% block breadcrumb %}
<span class="text-notion-text-secondary">ì‚¬ì´íŠ¸ ì„¤ì •</span>
<span class="mx-2 text-notion-text-muted">/</span>
<span class="text-notion-text font-medium">ë©”ì¸ ì‚¬ì§„</span>
{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-xl font-semibold text-notion-text">ë©”ì¸ ì‚¬ì§„ ê´€ë¦¬</h1>
        <p class="text-sm text-notion-text-muted mt-1">ë©”ì¸ í˜ì´ì§€ íˆì–´ë¡œ ìŠ¬ë¼ì´ë”ì— í‘œì‹œë˜ëŠ” ì‚¬ì§„ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
    </div>
    <a href="{{ url_for('admin.hero_photos_new') }}" class="btn-notion btn-primary">+ ì‚¬ì§„ ì¶”ê°€</a>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="sortable-grid">
    {% for photo in photos %}
    <div class="card-notion overflow-hidden" data-id="{{ photo.id }}">
        <div class="aspect-video bg-notion-sidebar relative group">
            {% if photo.url %}
            <img src="{{ photo.url }}" alt="" class="w-full h-full object-cover">
            {% else %}
            <div class="w-full h-full flex items-center justify-center text-notion-text-muted">
                <span class="text-4xl">ğŸ–¼ï¸</span>
            </div>
            {% endif %}
            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-3">
                <a href="{{ url_for('admin.hero_photos_edit', id=photo.id) }}" class="btn-notion bg-white text-notion-text text-sm">ìˆ˜ì •</a>
                <button onclick="deletePhoto({{ photo.id }})" class="btn-notion btn-danger text-sm">ì‚­ì œ</button>
            </div>
            <!-- í™œì„±í™” í† ê¸€ -->
            <button onclick="toggleActive({{ photo.id }})"
                    class="absolute top-2 right-2 px-2 py-1 text-xs rounded {{ 'bg-green-500 text-white' if photo.is_active else 'bg-gray-400 text-white' }}">
                {{ 'í™œì„±' if photo.is_active else 'ë¹„í™œì„±' }}
            </button>
            <!-- ë“œë˜ê·¸ í•¸ë“¤ -->
            <div class="absolute top-2 left-2 cursor-move text-white bg-black/30 px-2 py-1 rounded text-xs drag-handle">â‹®â‹®</div>
        </div>
        <div class="p-4">
            <p class="text-sm text-notion-text line-clamp-2">{{ photo.description or 'ì„¤ëª… ì—†ìŒ' }}</p>
        </div>
    </div>
    {% else %}
    <div class="col-span-full text-center py-12 text-notion-text-muted">
        ë“±ë¡ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.
    </div>
    {% endfor %}
</div>

<p class="text-xs text-notion-text-muted mt-4">ğŸ’¡ ì¹´ë“œë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
new Sortable(document.getElementById('sortable-grid'), {
    animation: 150,
    handle: '.drag-handle',
    onEnd: function() {
        const order = [...document.querySelectorAll('#sortable-grid [data-id]')].map(el => el.dataset.id);
        fetch('{{ url_for("admin.hero_photos_reorder") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order })
        })
        .then(res => {
            if (!res.ok) {
                throw new Error('ì¬ì •ë ¬ ì €ì¥ ì‹¤íŒ¨');
            }
        })
        .catch(err => {
            console.error('ì¬ì •ë ¬ ì˜¤ë¥˜:', err);
            alert('ìˆœì„œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
            location.reload();
        });
    }
});

function toggleActive(id) {
    fetch(`/hero-photos/${id}/toggle-active`, { method: 'POST' })
        .then(res => {
            if (!res.ok) {
                return res.text().then(text => {
                    throw new Error(`í™œì„±í™” í† ê¸€ ì‹¤íŒ¨ (${res.status}): ${text}`);
                });
            }
            return res;
        })
        .then(() => location.reload())
        .catch(err => {
            console.error('í† ê¸€ ì˜¤ë¥˜:', err);
            alert('í™œì„±í™” í† ê¸€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        });
}

function deletePhoto(id) {
    if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        fetch(`/hero-photos/${id}/delete`, { method: 'POST' })
            .then(res => {
                if (!res.ok) {
                    return res.text().then(text => {
                        throw new Error(`ì‚­ì œ ì‹¤íŒ¨ (${res.status}): ${text}`);
                    });
                }
                return res;
            })
            .then(() => location.reload())
            .catch(err => {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', err);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            });
    }
}
</script>
{% endblock %}
